--// Ziggy's Fly + ESP Menu (Safe Re-exec Version)

-- remove old GUI if re-executed
local oldGui = game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui"):FindFirstChild("ZiggyModMenu")
if oldGui then
    oldGui:Destroy()
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ZiggyModMenu"
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 180, 0, 120)
mainFrame.Position = UDim2.new(0.5, -90, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BorderSizePixel = 2
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
title.Text = "▼ Mod Menu"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextScaled = true
title.Parent = mainFrame

-- Collapse toggle
local collapsed = false
title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        collapsed = not collapsed
        if collapsed then
            title.Text = "▲ Mod Menu"
            for _, obj in ipairs(mainFrame:GetChildren()) do
                if obj ~= title then obj.Visible = false end
            end
            mainFrame.Size = UDim2.new(0, 180, 0, 25)
        else
            title.Text = "▼ Mod Menu"
            for _, obj in ipairs(mainFrame:GetChildren()) do
                if obj ~= title then obj.Visible = true end
            end
            mainFrame.Size = UDim2.new(0, 180, 0, 120)
        end
    end
end)

-- Checkbox function
local function createCheckbox(name, yPos)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -10, 0, 25)
    button.Position = UDim2.new(0, 5, 0, yPos)
    button.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextScaled = true
    button.Text = "[ ] " .. name
    button.Parent = mainFrame
    return button
end

-- Fly variables
local flying = false
local flySpeed = 50

-- ESP variables
local espEnabled = false
local highlights = {}

-- Fly function
local function setFlying(state)
    flying = state
    if flying then
        spawn(function()
            while flying do
                local char = LocalPlayer.Character
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local moveDir = Vector3.new(0, 0, 0)
                    local camCF = Camera.CFrame
                    local dir = Vector3.new()

                    -- WASD/Joystick movement
                    dir = camCF:VectorToWorldSpace(Vector3.new(
                        UserInputService:IsKeyDown(Enum.KeyCode.A) and -1 or (UserInputService:IsKeyDown(Enum.KeyCode.D) and 1 or 0),
                        0,
                        UserInputService:IsKeyDown(Enum.KeyCode.W) and -1 or (UserInputService:IsKeyDown(Enum.KeyCode.S) and 1 or 0)
                    ))

                    -- Vertical (Space = up, Shift = down)
                    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                        dir = dir + Vector3.new(0,1,0)
                    end
                    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
                        dir = dir + Vector3.new(0,-1,0)
                    end

                    -- Mobile support: JumpButton = up
                    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
                        if LocalPlayer.Character.Humanoid.Jump then
                            dir = dir + Vector3.new(0,1,0)
                        end
                    end

                    if dir.Magnitude > 0 then
                        hrp.AssemblyLinearVelocity = dir.Unit * flySpeed
                    else
                        hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
                    end
                end
                RunService.RenderStepped:Wait()
            end
        end)
    end
end

-- ESP function
local function setESP(state)
    espEnabled = state
    if espEnabled then
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer then
                local char = plr.Character
                if char and not highlights[plr] then
                    local highlight = Instance.new("Highlight")
                    highlight.FillTransparency = 1
                    highlight.OutlineColor = Color3.fromRGB(0,255,0)
                    highlight.OutlineTransparency = 0
                    highlight.Parent = char
                    highlights[plr] = highlight
                end
            end
        end
        Players.PlayerAdded:Connect(function(plr)
            plr.CharacterAdded:Connect(function(char)
                if espEnabled then
                    local highlight = Instance.new("Highlight")
                    highlight.FillTransparency = 1
                    highlight.OutlineColor = Color3.fromRGB(0,255,0)
                    highlight.OutlineTransparency = 0
                    highlight.Parent = char
                    highlights[plr] = highlight
                end
            end)
        end)
    else
        for plr, h in pairs(highlights) do
            if h then h:Destroy() end
            highlights[plr] = nil
        end
    end
end

-- Buttons
local flyBtn = createCheckbox("Fly", 30)
local espBtn = createCheckbox("ESP", 60)

flyBtn.MouseButton1Click:Connect(function()
    flying = not flying
    flyBtn.Text = (flying and "[x] " or "[ ] ") .. "Fly"
    setFlying(flying)
end)

espBtn.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    espBtn.Text = (espEnabled and "[x] " or "[ ] ") .. "ESP"
    setESP(espEnabled)
end)

-- Watermark
local watermark = Instance.new("TextLabel")
watermark.Size = UDim2.new(1, 0, 0, 20)
watermark.Position = UDim2.new(0, 0, 1, -20)
watermark.BackgroundTransparency = 1
watermark.Text = "@Ziggy"
watermark.TextColor3 = Color3.fromRGB(200, 200, 200)
watermark.TextScaled = true
watermark.Parent = mainFrame
