-- @Ziggy Collapsible Fly+ESP+Sticky+Invisible+RemoveRope Menu (final with server-visible invis + instant stick)
-- Invisible now sets both Transparency + LocalTransparencyModifier and tries to disable BillboardGuis/humanoid display (so others see it)
-- ESP neon-pink full-body highlight (no Highlight instance)
-- Fonts styled GothamBold, tick box white with black check
-- Sticky now snaps instantly to the target offset (no follow delay)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

-- Settings
local flying = false
local flySpeed = 50
local espEnabled = false
local espColor = Color3.fromRGB(255,105,180)
local highlights = {}
local espModified = {}
local stickyTarget = nil
local stickyActive = false
local stickOffset = Vector3.new(0,0,1)
local invisible = false
local originalProps = {}

-- Prevent duplicate GUI
if player:FindFirstChild("PlayerGui"):FindFirstChild("ZiggyMenu") then
    player.PlayerGui.ZiggyMenu:Destroy()
end

-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "ZiggyMenu"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 160, 0, 30)
frame.Position = UDim2.new(0.5, -80, 0.5, -15)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,30)
title.Position = UDim2.new(0,0,0,0)
title.BackgroundTransparency = 1
title.Text = "Mod Menu ▼"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Parent = frame

local expanded = false
local content = Instance.new("Frame")
content.Size = UDim2.new(1,0,0,240)
content.Position = UDim2.new(0,0,0,30)
content.BackgroundTransparency = 1
content.Visible = false
content.Parent = frame

title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        expanded = not expanded
        content.Visible = expanded
        frame.Size = expanded and UDim2.new(0,160,0,270) or UDim2.new(0,160,0,30)
        title.Text = expanded and "Mod Menu ▲" or "Mod Menu ▼"
    end
end)

-- Checkbox helper
local function createCheckbox(text, yPos, callback)
    local holder = Instance.new("Frame")
    holder.Size = UDim2.new(1,0,0,20)
    holder.Position = UDim2.new(0,0,0,yPos)
    holder.BackgroundTransparency = 1
    holder.Parent = content

    local box = Instance.new("TextButton")
    box.Size = UDim2.new(0,18,0,18)
    box.Position = UDim2.new(0,6,0,1)
    box.BackgroundColor3 = Color3.fromRGB(255,255,255) -- white box
    box.BorderSizePixel = 0
    box.Text = ""
    box.AutoButtonColor = false
    box.Parent = holder

    local check = Instance.new("TextLabel")
    check.Size = UDim2.new(1,0,1,0)
    check.BackgroundTransparency = 1
    check.Text = "✔"
    check.TextColor3 = Color3.fromRGB(0,0,0) -- black tick
    check.Visible = false
    check.Font = Enum.Font.GothamBold
    check.TextScaled = true
    check.Parent = box

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,-30,1,0)
    label.Position = UDim2.new(0,30,0,0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255,255,255)
    label.Text = text
    label.Font = Enum.Font.GothamBold
    label.TextScaled = true
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = holder

    local state = false
    local function toggle()
        state = not state
        check.Visible = state
        callback(state)
    end
    box.MouseButton1Click:Connect(toggle)
    label.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            toggle()
        end
    end)
end

-- Fly Checkbox
createCheckbox("Fly", 0, function(val)
    flying = val
    if not val and hrp then hrp.AssemblyLinearVelocity = Vector3.new(0,0,0) end
end)

-- ESP Checkbox (fixed)
createCheckbox("ESP", 28, function(val)
    espEnabled = val
    if not espEnabled then
        for inst, props in pairs(espModified) do
            if inst and inst.Parent then
                pcall(function() inst.LocalTransparencyModifier = props.LocalTransparencyModifier or 0 end)
                pcall(function() inst.Color = props.Color end)
                pcall(function() inst.Material = props.Material end)
            end
        end
        espModified = {}
    end
end)

-- Invisible Checkbox (now tries to hide for everyone — sets both Transparency & LocalTransparencyModifier and disables billboard guis/humanoid display)
createCheckbox("Invisible", 56, function(val)
    invisible = val
    if val then
        originalProps = {}
        if char then
            for _, inst in ipairs(char:GetDescendants()) do
                -- BaseParts: store Transparency and LocalTransparencyModifier, then set both to fully invisible
                if inst:IsA("BasePart") then
                    originalProps[inst] = {
                        Transparency = inst.Transparency
                    }
                    -- try store local modifier if present
                    local ok, prev = pcall(function() return inst.LocalTransparencyModifier end)
                    if ok then originalProps[inst].LocalTransparencyModifier = prev end
                    -- set both Transparency and LocalTransparencyModifier so it attempts to replicate (Transparency) and also hide locally
                    pcall(function() inst.Transparency = 1 end)
                    pcall(function() inst.LocalTransparencyModifier = 1 end)
                end

                -- DECALS / TEXTURES
                if inst:IsA("Decal") or inst:IsA("Texture") then
                    originalProps[inst] = {Transparency = inst.Transparency}
                    pcall(function() inst.Transparency = 1 end)
                end

                -- GUI elements attached to character (BillboardGui / SurfaceGui) - disable if possible
                if inst:IsA("BillboardGui") or inst:IsA("SurfaceGui") or inst:IsA("ScreenGui") then
                    -- store Enabled if exists
                    local ok, enabledPrev = pcall(function() return inst.Enabled end)
                    if ok then
                        originalProps[inst] = originalProps[inst] or {}
                        originalProps[inst].Enabled = enabledPrev
                        pcall(function() inst.Enabled = false end)
                    else
                        -- try Transparency on descendants (fallback)
                        for _, sub in ipairs(inst:GetDescendants()) do
                            if sub:IsA("TextLabel") or sub:IsA("ImageLabel") or sub:IsA("Frame") then
                                originalProps[sub] = originalProps[sub] or {}
                                local ok2, bg = pcall(function() return sub.BackgroundTransparency end)
                                if ok2 then originalProps[sub].BackgroundTransparency = bg end
                                pcall(function() sub.BackgroundTransparency = 1 end)
                            end
                        end
                    end
                end

                -- PARTICLE EMITTERS / TRAILS
                if inst:IsA("ParticleEmitter") or inst:IsA("Trail") then
                    originalProps[inst] = {Enabled = inst.Enabled}
                    pcall(function() inst.Enabled = false end)
                end
            end

            -- hide name/health bar by changing humanoid display type (store previous)
            if humanoid then
                originalProps[humanoid] = originalProps[humanoid] or {}
                originalProps[humanoid].DisplayDistanceType = humanoid.DisplayDistanceType
                pcall(function() humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None end)
            end
        end
    else
        -- Restore everything we saved
        for inst, props in pairs(originalProps) do
            if inst and inst.Parent then
                -- BasePart transparencies and LocalTransparencyModifier
                if props.Transparency ~= nil and inst:IsA("BasePart") then
                    pcall(function() inst.Transparency = props.Transparency end)
                end
                if props.LocalTransparencyModifier ~= nil and inst:IsA("BasePart") then
                    pcall(function() inst.LocalTransparencyModifier = props.LocalTransparencyModifier end)
                end

                -- Decal / Texture transparency
                if props.Transparency ~= nil and (inst:IsA("Decal") or inst:IsA("Texture")) then
                    pcall(function() inst.Transparency = props.Transparency end)
                end

                -- GUI enabled restore
                if props.Enabled ~= nil and (inst:IsA("BillboardGui") or inst:IsA("SurfaceGui") or inst:IsA("ScreenGui")) then
                    pcall(function() inst.Enabled = props.Enabled end)
                end

                -- ParticleEmitters / Trails
                if props.Enabled ~= nil and (inst:IsA("ParticleEmitter") or inst:IsA("Trail")) then
                    pcall(function() inst.Enabled = props.Enabled end)
                end

                -- Humanoid display restore (if stored on humanoid)
                if props.DisplayDistanceType ~= nil and typeof(inst) == "Instance" then
                    -- This will be executed when inst is the humanoid
                    pcall(function() inst.DisplayDistanceType = props.DisplayDistanceType end)
                end
            end
        end
        originalProps = {}
    end
end)

-- Player selector
local playerList = {}
local currentIndex = 1
local function refreshPlayerList()
    playerList = {}
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= player then table.insert(playerList, plr) end
    end
    if #playerList == 0 then
        currentIndex = 1
    elseif currentIndex > #playerList then
        currentIndex = 1
    end
end
refreshPlayerList()
Players.PlayerAdded:Connect(refreshPlayerList)
Players.PlayerRemoving:Connect(refreshPlayerList)

local selectorFrame = Instance.new("Frame")
selectorFrame.Size = UDim2.new(1,-10,0,20)
selectorFrame.Position = UDim2.new(0,5,0,85)
selectorFrame.BackgroundTransparency = 1
selectorFrame.Parent = content

local leftBtn = Instance.new("TextButton")
leftBtn.Size = UDim2.new(0,20,1,0)
leftBtn.Position = UDim2.new(0,0,0,0)
leftBtn.Text = "←"
leftBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
leftBtn.TextColor3 = Color3.fromRGB(255,255,255)
leftBtn.Font = Enum.Font.GothamBold
leftBtn.Parent = selectorFrame

local rightBtn = Instance.new("TextButton")
rightBtn.Size = UDim2.new(0,20,1,0)
rightBtn.Position = UDim2.new(1,-20,0,0)
rightBtn.Text = "→"
rightBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
rightBtn.TextColor3 = Color3.fromRGB(255,255,255)
rightBtn.Font = Enum.Font.GothamBold
rightBtn.Parent = selectorFrame

local targetLabel = Instance.new("TextLabel")
targetLabel.Size = UDim2.new(1,-40,1,0)
targetLabel.Position = UDim2.new(0,20,0,0)
targetLabel.BackgroundTransparency = 1
targetLabel.TextColor3 = Color3.fromRGB(255,255,255)
targetLabel.Font = Enum.Font.GothamBold
targetLabel.TextScaled = true
targetLabel.Parent = selectorFrame

local function updateTargetLabel()
    if #playerList > 0 then
        targetLabel.Text = "Target: "..playerList[currentIndex].Name
    else
        targetLabel.Text = "No players"
    end
end
updateTargetLabel()

leftBtn.MouseButton1Click:Connect(function()
    if #playerList > 0 then
        currentIndex = currentIndex - 1
        if currentIndex < 1 then currentIndex = #playerList end
        updateTargetLabel()
    end
end)
rightBtn.MouseButton1Click:Connect(function()
    if #playerList > 0 then
        currentIndex = currentIndex + 1
        if currentIndex > #playerList then currentIndex = 1 end
        updateTargetLabel()
    end
end)

-- Stick Button
local stickButton = Instance.new("TextButton")
stickButton.Size = UDim2.new(1,-10,0,20)
stickButton.Position = UDim2.new(0,5,0,110)
stickButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
stickButton.TextColor3 = Color3.fromRGB(255,255,255)
stickButton.Text = "Stick to Back"
stickButton.Font = Enum.Font.GothamBold
stickButton.TextScaled = true
stickButton.Parent = content

stickButton.MouseButton1Click:Connect(function()
    if #playerList > 0 then
        stickyTarget = playerList[currentIndex]
        stickyActive = true
    end
end)

-- Unstick Button
local unstickButton = Instance.new("TextButton")
unstickButton.Size = UDim2.new(1,-10,0,20)
unstickButton.Position = UDim2.new(0,5,0,135)
unstickButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
unstickButton.TextColor3 = Color3.fromRGB(255,255,255)
unstickButton.Text = "Unstick"
unstickButton.Font = Enum.Font.GothamBold
unstickButton.TextScaled = true
unstickButton.Parent = content

unstickButton.MouseButton1Click:Connect(function()
    stickyTarget = nil
    stickyActive = false
end)

-- Remove Rope Button
local ropeButton = Instance.new("TextButton")
ropeButton.Size = UDim2.new(1,-10,0,20)
ropeButton.Position = UDim2.new(0,5,0,160)
ropeButton.BackgroundColor3 = Color3.fromRGB(100,40,40)
ropeButton.TextColor3 = Color3.fromRGB(255,255,255)
ropeButton.Text = "Remove Rope"
ropeButton.Font = Enum.Font.GothamBold
ropeButton.TextScaled = true
ropeButton.Parent = content

ropeButton.MouseButton1Click:Connect(function()
    local map = Workspace:FindFirstChild("Map")
    if map and map:FindFirstChild("JumpRope") then
        for _, dollName in ipairs({"Doll1","Doll2"}) do
            local doll = map.JumpRope:FindFirstChild(dollName)
            if doll and doll:FindFirstChild("DOLL123123") and doll.DOLL123123:FindFirstChild("ropeholder") then
                doll.DOLL123123.ropeholder:ClearAllChildren()
            end
        end
    end
end)

-- Watermark
local watermark = Instance.new("TextLabel")
watermark.Size = UDim2.new(1,0,0,15)
watermark.Position = UDim2.new(0,0,0,185)
watermark.BackgroundTransparency = 1
watermark.Text = "@Ziggy"
watermark.TextColor3 = Color3.fromRGB(255,255,255)
watermark.Font = Enum.Font.GothamBold
watermark.TextScaled = true
watermark.Parent = content

-- ESP helper
local function enableESPForCharacter(ch)
    if not ch then return end
    for _, inst in ipairs(ch:GetDescendants()) do
        if inst:IsA("BasePart") then
            if not espModified[inst] then
                local ok, ltm = pcall(function() return inst.LocalTransparencyModifier end)
                espModified[inst] = {
                    LocalTransparencyModifier = ok and ltm or nil,
                    Color = inst.Color,
                    Material = inst.Material
                }
            end
            pcall(function() inst.LocalTransparencyModifier = 0 end)
            pcall(function() inst.Color = espColor end)
            pcall(function() inst.Material = Enum.Material.Neon end)
        end
    end
end

local function disableESPForCharacter(ch)
    if not ch then return end
    for _, inst in ipairs(ch:GetDescendants()) do
        local props = espModified[inst]
        if props then
            pcall(function() inst.LocalTransparencyModifier = props.LocalTransparencyModifier or 0 end)
            pcall(function() inst.Color = props.Color end)
            pcall(function() inst.Material = props.Material end)
            espModified[inst] = nil
        end
    end
end

-- Refresh loop
RunService.Heartbeat:Connect(function()
    refreshPlayerList()
    updateTargetLabel()
    if espEnabled then
        for _,plr in pairs(Players:GetPlayers()) do
            if plr ~= player then
                local ch = plr.Character
                if ch then enableESPForCharacter(ch) end
            end
        end
    end
end)

-- Fly + Sticky
RunService.RenderStepped:Connect(function()
    if flying and hrp and humanoid then
        local cam = Workspace.CurrentCamera
        local look = cam.CFrame.LookVector
        local right = cam.CFrame.RightVector
        local horizLook = Vector3.new(look.X, 0, look.Z)
        local forwardAxis = (horizLook.Magnitude > 0.001) and horizLook.Unit or Vector3.new(0,0,-1)
        local rightAxis = Vector3.new(right.X, 0, right.Z)
        rightAxis = (rightAxis.Magnitude > 0.001) and rightAxis.Unit or Vector3.new(1,0,0)
        local moveDir = humanoid.MoveDirection
        local forwardInput = moveDir:Dot(forwardAxis)
        local rightInput = moveDir:Dot(rightAxis)
        local desired = cam.CFrame.LookVector * forwardInput + cam.CFrame.RightVector * rightInput
        if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
            desired = desired - Vector3.new(0,1,0)
        end
        hrp.AssemblyLinearVelocity = desired * flySpeed
    end

    if stickyActive and stickyTarget and stickyTarget.Character and stickyTarget.Character:FindFirstChild("HumanoidRootPart") and hrp then
        local targetHRP = stickyTarget.Character.HumanoidRootPart
        -- snap instantly to the offset relative to target (no follow smoothing)
        local stickCF = targetHRP.CFrame * CFrame.new(stickOffset)
        hrp.CFrame = stickCF
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    if plr and plr.Character then
        disableESPForCharacter(plr.Character)
    end
end)

player.CharacterAdded:Connect(function(c)
    char = c
    hrp = char:WaitForChild("HumanoidRootPart")
    humanoid = char:WaitForChild("Humanoid")

    if invisible then
        wait(0.1)
        for _, inst in ipairs(char:GetDescendants()) do
            if inst:IsA("BasePart") then
                originalProps[inst] = {
                    Transparency = inst.Transparency
                }
                local ok, prev = pcall(function() return inst.LocalTransparencyModifier end)
                if ok then originalProps[inst].LocalTransparencyModifier = prev end
                pcall(function() inst.Transparency = 1 end)
                pcall(function() inst.LocalTransparencyModifier = 1 end)
            end
            if inst:IsA("Decal") or inst:IsA("Texture") then
                originalProps[inst] = {Transparency = inst.Transparency}
                pcall(function() inst.Transparency = 1 end)
            end
            if inst:IsA("ParticleEmitter") or inst:IsA("Trail") then
                originalProps[inst] = {Enabled = inst.Enabled}
                pcall(function() inst.Enabled = false end)
            end
        end
        if humanoid then
            originalProps[humanoid] = originalProps[humanoid] or {}
            originalProps[humanoid].DisplayDistanceType = humanoid.DisplayDistanceType
            pcall(function() humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None end)
        end
    end

    if espEnabled then enableESPForCharacter(char) end
end)
