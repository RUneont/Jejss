--// Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

--// Fly variables
local flying = false
local flySpeed = 50
local flyConnection

--// ESP storage
local espEnabled = false
local espConnections = {}

--// Fly functions
local function startFly()
    if flying then return end
    flying = true

    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local hrp = character:WaitForChild("HumanoidRootPart")

    flyConnection = RunService.RenderStepped:Connect(function()
        if not flying or not character or not hrp then return end

        local moveDir = humanoid.MoveDirection
        local velocity = moveDir * flySpeed

        -- Up & Down controls
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) or humanoid.Jump then
            velocity = velocity + Vector3.new(0, flySpeed, 0)
        elseif UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            velocity = velocity + Vector3.new(0, -flySpeed, 0)
        end

        hrp.Velocity = velocity
    end)
end

local function stopFly()
    flying = false
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end

    local character = LocalPlayer.Character
    local hrp = character and character:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.Velocity = Vector3.new(0,0,0)
    end
end

--// ESP functions
local function enableESP()
    if espEnabled then return end
    espEnabled = true
    for _,player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESP_Highlight"
            highlight.FillTransparency = 1
            highlight.OutlineColor = Color3.fromRGB(0,255,0)
            highlight.Parent = player.Character
        end
    end
    table.insert(espConnections, Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function(char)
            if espEnabled then
                local highlight = Instance.new("Highlight")
                highlight.Name = "ESP_Highlight"
                highlight.FillTransparency = 1
                highlight.OutlineColor = Color3.fromRGB(0,255,0)
                highlight.Parent = char
            end
        end)
    end))
end

local function disableESP()
    espEnabled = false
    for _,player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local h = player.Character:FindFirstChild("ESP_Highlight")
            if h then h:Destroy() end
        end
    end
    for _,con in ipairs(espConnections) do
        con:Disconnect()
    end
    espConnections = {}
end

--// GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
screenGui.Name = "Ziggy Menu"

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0,180,0,120)
frame.Position = UDim2.new(0.5,-90,0.4,0)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Text = "Mod Menu - @Ziggy"
title.Size = UDim2.new(1,0,0,30)
title.BackgroundColor3 = Color3.fromRGB(50,50,50)
title.TextColor3 = Color3.new(1,1,1)
title.Parent = frame

-- Fly Button
local flyButton = Instance.new("TextButton")
flyButton.Text = "[ ] Fly"
flyButton.Size = UDim2.new(1,-10,0,30)
flyButton.Position = UDim2.new(0,5,0,40)
flyButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
flyButton.TextColor3 = Color3.new(1,1,1)
flyButton.Parent = frame

-- ESP Button
local espButton = Instance.new("TextButton")
espButton.Text = "[ ] ESP"
espButton.Size = UDim2.new(1,-10,0,30)
espButton.Position = UDim2.new(0,5,0,80)
espButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
espButton.TextColor3 = Color3.new(1,1,1)
espButton.Parent = frame

-- Button logic
flyButton.MouseButton1Click:Connect(function()
    if flying then
        stopFly()
        flyButton.Text = "[ ] Fly"
    else
        startFly()
        flyButton.Text = "[x] Fly"
    end
end)

espButton.MouseButton1Click:Connect(function()
    if espEnabled then
        disableESP()
        espButton.Text = "[ ] ESP"
    else
        enableESP()
        espButton.Text = "[x] ESP"
    end
end)
