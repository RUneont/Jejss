-- @Ziggy Collapsible Fly+ESP Menu (Mobile + PC)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

local flying = false
local flySpeed = 50

local espEnabled = false
local espColor = Color3.fromRGB(0,255,0)
local highlights = {}

-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "ZiggyMenu"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 180, 0, 35) -- collapsed
frame.Position = UDim2.new(0.5, -90, 0.5, -20)
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

-- Title
local title = Instance.new("TextButton")
title.Size = UDim2.new(1,0,0,35)
title.Text = "Mod Menu ▼"
title.BackgroundColor3 = Color3.fromRGB(40,40,40)
title.TextColor3 = Color3.fromRGB(255,255,255)
title.Font = Enum.Font.SourceSansBold
title.TextScaled = true
title.Parent = frame

local expanded = false

-- Content
local content = Instance.new("Frame")
content.Size = UDim2.new(1,0,0,70)
content.Position = UDim2.new(0,0,0,35)
content.BackgroundColor3 = Color3.fromRGB(30,30,30)
content.Visible = false
content.Parent = frame

-- Watermark
local watermark = Instance.new("TextLabel")
watermark.Size = UDim2.new(1,0,0,15)
watermark.Position = UDim2.new(0,0,1,0)
watermark.BackgroundTransparency = 1
watermark.Text = "@Ziggy"
watermark.TextColor3 = Color3.fromRGB(150,150,150)
watermark.Font = Enum.Font.SourceSansItalic
watermark.TextScaled = true
watermark.Parent = frame

-- Collapse toggle
title.MouseButton1Click:Connect(function()
    expanded = not expanded
    content.Visible = expanded
    frame.Size = expanded and UDim2.new(0,180,0,110) or UDim2.new(0,180,0,35)
    title.Text = expanded and "Mod Menu ▲" or "Mod Menu ▼"
end)

-- Helper: Checkbox
local function createCheckbox(labelText, yPos, callback)
    local holder = Instance.new("Frame")
    holder.Size = UDim2.new(1, -10, 0, 25)
    holder.Position = UDim2.new(0, 5, 0, yPos)
    holder.BackgroundTransparency = 1
    holder.Parent = content

    local box = Instance.new("TextButton")
    box.Size = UDim2.new(0,20,0,20)
    box.Position = UDim2.new(0,0,0,2)
    box.BackgroundColor3 = Color3.fromRGB(60,60,60)
    box.Text = ""
    box.Parent = holder

    local checkmark = Instance.new("TextLabel")
    checkmark.Size = UDim2.new(1,0,1,0)
    checkmark.BackgroundTransparency = 1
    checkmark.Text = "✓"
    checkmark.TextColor3 = Color3.fromRGB(0,255,0)
    checkmark.Visible = false
    checkmark.Parent = box

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,-30,1,0)
    label.Position = UDim2.new(0,30,0,0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextColor3 = Color3.fromRGB(255,255,255)
    label.Font = Enum.Font.SourceSans
    label.TextScaled = true
    label.Parent = holder

    local state = false
    box.MouseButton1Click:Connect(function()
        state = not state
        checkmark.Visible = state
        callback(state)
    end)
end

-- Fly Checkbox
createCheckbox("Fly", 5, function(val)
    flying = val
    humanoid.PlatformStand = val
    if not val then hrp.Velocity = Vector3.new(0,0,0) end
end)

-- ESP Checkbox
createCheckbox("ESP", 35, function(val)
    espEnabled = val
    if not val then
        for _, hl in pairs(highlights) do
            hl:Destroy()
        end
        highlights = {}
    end
end)

-- ESP loop
RunService.RenderStepped:Connect(function()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if espEnabled then
                if not highlights[plr] then
                    local hl = Instance.new("Highlight")
                    hl.Adornee = plr.Character
                    hl.FillTransparency = 1
                    hl.OutlineColor = espColor
                    hl.OutlineTransparency = 0
                    hl.Parent = gui
                    highlights[plr] = hl
                end
            else
                if highlights[plr] then
                    highlights[plr]:Destroy()
                    highlights[plr] = nil
                end
            end
        end
    end
end)

-- Fly movement (supports PC + mobile joystick)
RunService.RenderStepped:Connect(function()
    if flying then
        local moveDir = humanoid.MoveDirection
        local velocity = moveDir * flySpeed

        if UIS:IsKeyDown(Enum.KeyCode.Space) or humanoid.Jump then
            velocity = velocity + Vector3.new(0, flySpeed, 0)
        elseif UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
            velocity = velocity - Vector3.new(0, flySpeed, 0)
        end

        hrp.Velocity = velocity
    end
end)
