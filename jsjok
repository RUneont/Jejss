-- @Ziggy Collapsible Fly+ESP Menu (Mobile + PC, Fixed Fly + Checkboxes)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

local flying = false
local flySpeed = 50

local espEnabled = false
local espColor = Color3.fromRGB(0,255,0)
local highlights = {}

-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "ZiggyMenu"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 160, 0, 30)
frame.Position = UDim2.new(0.5, -80, 0.5, -15)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

-- Title
local title = Instance.new("TextButton")
title.Size = UDim2.new(1,0,0,30)
title.BackgroundTransparency = 1
title.Text = "Mod Menu ▼"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.SourceSansBold
title.TextScaled = true
title.Parent = frame

local watermark = Instance.new("TextLabel")
watermark.Size = UDim2.new(1,0,0,15)
watermark.Position = UDim2.new(0,0,1,0)
watermark.BackgroundTransparency = 1
watermark.Text = "@Ziggy"
watermark.TextColor3 = Color3.fromRGB(150,150,150)
watermark.Font = Enum.Font.SourceSansItalic
watermark.TextScaled = true
watermark.Parent = frame

local expanded = false

local content = Instance.new("Frame")
content.Size = UDim2.new(1,0,0,50)
content.Position = UDim2.new(0,0,0,30)
content.BackgroundTransparency = 1
content.Visible = false
content.Parent = frame

-- Collapse
title.MouseButton1Click:Connect(function()
    expanded = not expanded
    content.Visible = expanded
    frame.Size = expanded and UDim2.new(0,160,0,80) or UDim2.new(0,160,0,30)
    title.Text = expanded and "Mod Menu ▲" or "Mod Menu ▼"
end)

-- Checkbox helper
local function createCheckbox(text, yPos, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1,0,0,20)
    button.Position = UDim2.new(0,0,0,yPos)
    button.BackgroundTransparency = 1
    button.TextColor3 = Color3.new(1,1,1)
    button.Font = Enum.Font.SourceSans
    button.TextScaled = true
    button.Text = "☐ "..text
    button.Parent = content

    local ticked = false
    button.MouseButton1Click:Connect(function()
        ticked = not ticked
        button.Text = (ticked and "☑ " or "☐ ")..text
        callback(ticked)
    end)
end

-- Fly Checkbox
createCheckbox("Fly", 0, function(val)
    flying = val
    if not val then
        hrp.Velocity = Vector3.zero
    end
end)

-- ESP Checkbox
createCheckbox("ESP", 25, function(val)
    espEnabled = val
    if not val then
        for _, hl in pairs(highlights) do
            hl:Destroy()
        end
        highlights = {}
    end
end)

-- ESP Update
RunService.RenderStepped:Connect(function()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if espEnabled then
                if not highlights[plr] then
                    local hl = Instance.new("Highlight")
                    hl.Adornee = plr.Character
                    hl.FillTransparency = 1
                    hl.OutlineColor = espColor
                    hl.OutlineTransparency = 0
                    hl.Parent = gui
                    highlights[plr] = hl
                end
            elseif highlights[plr] then
                highlights[plr]:Destroy()
                highlights[plr] = nil
            end
        end
    end
end)

-- Fly Movement
RunService.RenderStepped:Connect(function()
    if flying then
        local moveDir = humanoid.MoveDirection
        local velocity = moveDir * flySpeed

        -- Up
        if UIS:IsKeyDown(Enum.KeyCode.Space) or humanoid.Jump then
            velocity = velocity + Vector3.new(0, flySpeed, 0)
        end
        -- Down
        if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
            velocity = velocity - Vector3.new(0, flySpeed, 0)
        end

        hrp.AssemblyLinearVelocity = velocity
    end
end)
